name: Deploy via Enclii (K8s)

# Manual deployment workflow for dhanam-web via Enclii.
# Auto-deploy is handled by deploy-web-k8s.yml (push → build → digest commit → ArgoCD sync).
# Use this workflow only for manual/emergency deployments.

on:
  # Disabled: Enclii handles auto-deploy
  # push:
  #   branches: [main]
  #   paths:
  #     - 'apps/web/**'
  #     - 'packages/**'
  #     - 'pnpm-lock.yaml'
  #     - '.enclii.yml'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest commit SHA)'
        required: false
        type: string
      force_rebuild:
        description: 'Force rebuild even if image exists'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: madfam-org/dhanam/web

concurrency:
  group: deploy-enclii-${{ github.ref }}
  cancel-in-progress: false

jobs:
  preflight:
    name: Preflight Check
    runs-on: ubuntu-latest
    environment: production
    outputs:
      skip: ${{ steps.check-secret.outputs.skip }}
    steps:
      - name: Check KUBECONFIG secret
        id: check-secret
        run: |
          if [ -z "${{ secrets.KUBECONFIG_PRODUCTION }}" ]; then
            echo "::notice::KUBECONFIG_PRODUCTION secret not configured - skipping deployment"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build and Push to GHCR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.vars.outputs.sha_short }}
      image_full: ${{ steps.vars.outputs.image_full }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          echo "sha_short=$SHA_SHORT" >> $GITHUB_OUTPUT
          echo "image_full=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$SHA_SHORT" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: madfam-bot
          password: ${{ secrets.MADFAM_BOT_PAT }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Disable provenance attestations to avoid GHCR 403 errors
          # See: https://github.com/docker/build-push-action/issues/981
          provenance: false
          sbom: false
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.dhan.am/v1
            NEXT_PUBLIC_BASE_URL=https://app.dhan.am
            NEXT_PUBLIC_OIDC_ISSUER=https://auth.madfam.io
            NEXT_PUBLIC_OIDC_CLIENT_ID=jnc_uE2zp9ume_Fd6jMl1elL6wqjiECM711t
            NEXT_PUBLIC_JANUA_API_URL=https://api.janua.dev

  deploy:
    name: Deploy to Enclii K8s
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: needs.preflight.outputs.skip != 'true'
    environment: production

    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl cluster-info

      - name: Update GHCR credentials
        run: |
          kubectl delete secret ghcr-credentials -n dhanam --ignore-not-found
          kubectl create secret docker-registry ghcr-credentials \
            --namespace=dhanam \
            --docker-server=ghcr.io \
            --docker-username=madfam-bot \
            --docker-password=${{ secrets.MADFAM_BOT_PAT }} \
            --docker-email=ci@dhanam.dev

      - name: Deploy to K8s
        run: |
          NAMESPACE="dhanam"
          DEPLOYMENT="dhanam-web"
          IMAGE="${{ needs.build.outputs.image_full }}"

          echo "=== Deploying Dhanam Web ==="
          echo "Image: $IMAGE"
          echo ""

          # Update deployment
          kubectl set image deployment/$DEPLOYMENT \
            $DEPLOYMENT=$IMAGE \
            -n $NAMESPACE

          # Wait for rollout
          kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=300s

          # Verify pods
          echo ""
          echo "=== Deployment Status ==="
          kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT -o wide

      - name: Wait for deployment stabilization
        run: |
          echo "Waiting 30s for deployment to stabilize..."
          sleep 30

      - name: Verify deployment health
        id: health_check
        run: |
          echo "Verifying deployment health..."
          MAX_ATTEMPTS=10
          DELAY=10

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Health check attempt $i/$MAX_ATTEMPTS..."

            # Check health endpoint
            RESPONSE=$(curl -sf -w "\n%{http_code}" https://app.dhan.am/api/health 2>/dev/null || echo "000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "Health check passed (HTTP $HTTP_CODE)"
              echo "Response: $BODY"
              echo "health_status=passed" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$HTTP_CODE" = "503" ]; then
              echo "Service degraded (HTTP $HTTP_CODE)"
              echo "Response: $BODY"
            else
              echo "Health check failed (HTTP $HTTP_CODE)"
            fi

            if [ $i -lt $MAX_ATTEMPTS ]; then
              echo "Waiting ${DELAY}s before next attempt..."
              sleep $DELAY
            fi
          done

          echo "health_status=failed" >> $GITHUB_OUTPUT
          echo "Health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Trigger rollback on failure
        if: failure() && steps.health_check.outputs.health_status == 'failed'
        run: |
          echo "::error::Deployment health check failed - consider rollback"
          echo "## Deployment Health Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment did not pass health checks after stabilization." >> $GITHUB_STEP_SUMMARY
          echo "**Action Required**: Review logs and consider rolling back to previous version." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To rollback manually:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout undo deployment/dhanam-web -n dhanam" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Generate summary
        if: always()
        run: |
          echo "## Enclii Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ needs.build.outputs.image_full }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ needs.build.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: https://app.dhan.am" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.health_check.outputs.health_status }}" = "passed" ]; then
            echo "**Status**: Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: Health check issues detected" >> $GITHUB_STEP_SUMMARY
          fi
