#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Quick Jest module resolution check (runs in <2s)
echo "Checking Jest module resolution..."
cd apps/api
if ! pnpm jest --passWithNoTests --testPathPattern="nonexistent" 2>&1 | head -5 | grep -q "No tests found"; then
  # Check for module resolution errors
  if pnpm jest --passWithNoTests --testPathPattern="nonexistent" 2>&1 | grep -q "Cannot find module"; then
    echo "❌ Jest module resolution issues detected. Check moduleNameMapper in jest.config.js"
    exit 1
  fi
fi
cd - > /dev/null

# Run linting on staged files
pnpm lint-staged || {
  echo "❌ Lint errors found. Please fix them before committing."
  exit 1
}

# Run TypeScript type checking on affected packages
# This catches type errors before they reach CI
echo "Running TypeScript type check..."
pnpm typecheck || {
  echo "❌ TypeScript errors found. Please fix them before committing."
  exit 1
}

# Check for schema drift if Prisma files changed
if git diff --cached --name-only | grep -q "prisma/schema.prisma"; then
  echo "Checking Prisma schema..."
  cd apps/api
  if ! pnpm prisma validate; then
    echo "❌ Prisma schema validation failed."
    exit 1
  fi
  echo "✅ Prisma schema valid"
fi
