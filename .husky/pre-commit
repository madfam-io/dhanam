#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Quick Jest module resolution check (runs in <2s)
echo "Checking Jest module resolution..."
cd apps/api
if ! pnpm jest --passWithNoTests --testPathPattern="nonexistent" 2>&1 | head -5 | grep -q "No tests found"; then
  # Check for module resolution errors
  if pnpm jest --passWithNoTests --testPathPattern="nonexistent" 2>&1 | grep -q "Cannot find module"; then
    echo "‚ùå Jest module resolution issues detected. Check moduleNameMapper in jest.config.js"
    exit 1
  fi
fi
cd - > /dev/null

# Run linting on staged files
pnpm lint-staged || {
  echo "‚ùå Lint errors found. Please fix them before committing."
  exit 1
}

# Run TypeScript type checking on affected packages
# This catches type errors before they reach CI
echo "Running TypeScript type check..."
pnpm typecheck || {
  echo "‚ùå TypeScript errors found. Please fix them before committing."
  exit 1
}

# Run tests on changed API files to catch failures before CI
if git diff --cached --name-only | grep -q "apps/api/"; then
  echo "üß™ Running tests on affected API files..."
  cd apps/api
  # Run jest with bail flag to stop on first failure, --passWithNoTests for files without tests
  if ! pnpm jest --bail --passWithNoTests --findRelatedTests $(git diff --cached --name-only | grep "apps/api/" | sed 's|apps/api/||g' | tr '\n' ' ') 2>/dev/null; then
    echo "‚ùå Test failures detected. Please fix them before committing."
    exit 1
  fi
  cd - > /dev/null
  echo "‚úÖ API tests passed"
fi

# Check for schema drift if Prisma files changed
if git diff --cached --name-only | grep -q "prisma/schema.prisma"; then
  echo "Checking Prisma schema..."
  cd apps/api
  if ! pnpm prisma validate; then
    echo "‚ùå Prisma schema validation failed."
    exit 1
  fi
  echo "‚úÖ Prisma schema valid"
fi
