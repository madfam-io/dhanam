#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "Running pre-push checks..."

# Full type check
pnpm typecheck || {
  echo "❌ Type check failed. Push aborted."
  exit 1
}

# Run lint across entire codebase
pnpm lint || {
  echo "❌ Lint check failed. Push aborted."
  exit 1
}

# Check if schema.prisma was modified without a migration
if git diff origin/main --name-only 2>/dev/null | grep -q "prisma/schema.prisma"; then
  MIGRATION_CHANGES=$(git diff origin/main --name-only 2>/dev/null | grep "prisma/migrations" | wc -l | tr -d ' ')
  if [ "$MIGRATION_CHANGES" -eq 0 ]; then
    echo ""
    echo "⚠️  Warning: schema.prisma modified but no new migration detected"
    echo "   Run 'cd apps/api && pnpm prisma migrate dev --name <migration_name>' to create a migration"
    echo ""
  fi
fi

# Check for uncommitted schema drift
cd apps/api
if pnpm prisma migrate status 2>&1 | grep -q "have not yet been applied"; then
  echo "⚠️  Warning: Pending migrations detected"
fi

echo "✅ Pre-push checks passed"
