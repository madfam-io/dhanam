// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum SpaceType {
  personal
  business
}

enum SpaceRole {
  owner
  admin
  member
  viewer
}

enum AccountType {
  checking
  savings
  credit
  investment
  crypto
  other
}

enum Provider {
  belvo
  plaid
  mx
  finicity
  bitso
  blockchain
  manual
}

enum ConnectionStatus {
  active
  error
  syncing
  disconnected
}

enum BudgetPeriod {
  monthly
  quarterly
  yearly
}

enum Currency {
  MXN
  USD
  EUR
}

enum SubscriptionTier {
  community    // self-hosted or free cloud trial
  essentials   // $4.99/mo
  pro          // $11.99/mo
}

enum BillingEventType {
  subscription_created
  subscription_renewed
  subscription_cancelled
  payment_succeeded
  payment_failed
  refund_issued
}

enum BillingStatus {
  pending
  succeeded
  failed
  refunded
}

enum UsageMetricType {
  esg_calculation
  monte_carlo_simulation
  goal_probability
  scenario_analysis
  portfolio_rebalance
  api_request
}

enum ManualAssetType {
  real_estate
  vehicle
  domain
  private_equity
  angel_investment
  collectible
  art
  jewelry
  other
}

// Private Equity Cash Flow Types
enum PECashFlowType {
  capital_call // Money going into the investment
  distribution // Money coming back from the investment
  management_fee // Fees paid to fund managers
  carry // Carried interest payments
  recallable // Previously distributed amounts that can be recalled
}

enum AccountOwnership {
  individual // Owned by a single household member
  joint // Shared by multiple household members
  trust // Held in trust
}

enum GoalType {
  retirement
  education
  house_purchase
  emergency_fund
  legacy
  travel
  business
  debt_payoff
  other
}

enum GoalStatus {
  active
  paused
  achieved
  abandoned
}

enum GoalShareRole {
  viewer // Can view goal and progress
  contributor // Can view and add contributions
  editor // Can view, contribute, and edit goal parameters
  manager // Full access including sharing with others
}

enum GoalShareStatus {
  pending // Invitation sent but not accepted
  accepted // Invitation accepted
  declined // Invitation declined
  revoked // Access was revoked
}

enum GoalActivityAction {
  created // Goal was created
  updated // Goal parameters updated
  shared // Goal was shared with someone
  share_accepted // Someone accepted a goal share
  share_declined // Someone declined a goal share
  contribution_added // Contribution made toward goal
  probability_improved // Monte Carlo probability increased
  probability_declined // Monte Carlo probability decreased
  milestone_reached // Progress milestone (25%, 50%, 75%, 100%)
  target_date_extended // Target date was pushed back
  target_amount_adjusted // Target amount was changed
  allocation_updated // Account allocation changed
  what_if_scenario_run // What-if scenario was simulated
  comment_added // Comment/note was added
  achieved // Goal was achieved
  paused // Goal was paused
  abandoned // Goal was abandoned
}

enum HouseholdType {
  family
  trust
  estate
  partnership
}

enum RelationshipType {
  spouse
  partner
  child
  parent
  sibling
  grandparent
  grandchild
  dependent
  trustee
  beneficiary
  other
}

enum SimulationType {
  monte_carlo
  retirement
  goal_probability
  safe_withdrawal
  scenario_analysis
}

enum WillStatus {
  draft
  active
  revoked
  executed
}

enum AssetType {
  bank_account
  investment_account
  crypto_account
  real_estate
  business_interest
  personal_property
  other
}

// Models
model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  passwordHash          String    @map("password_hash")
  name                  String
  dateOfBirth           DateTime? @map("date_of_birth") @db.Date
  locale                String    @default("es")
  timezone              String    @default("America/Mexico_City")
  totpSecret            String?   @map("totp_secret")
  totpTempSecret        String?   @map("totp_temp_secret")
  totpEnabled           Boolean   @default(false) @map("totp_enabled")
  totpBackupCodes       String[]  @default([]) @map("totp_backup_codes")
  emailVerified         Boolean   @default(false) @map("email_verified")
  isActive              Boolean   @default(true) @map("is_active")
  isAdmin               Boolean   @default(false) @map("is_admin")
  onboardingCompleted   Boolean   @default(false) @map("onboarding_completed")
  onboardingCompletedAt DateTime? @map("onboarding_completed_at")
  onboardingStep        String?   @map("onboarding_step")
  lastLoginAt           DateTime? @map("last_login_at")
  lastActivityAt        DateTime? @map("last_activity_at")

  // Life Beat (Dead Man's Switch) settings
  lifeBeatEnabled       Boolean   @default(false) @map("life_beat_enabled")
  lifeBeatAlertDays     Int[]     @default([30, 60, 90]) @map("life_beat_alert_days") // Days of inactivity before alerts
  lifeBeatLegalAgreedAt DateTime? @map("life_beat_legal_agreed_at")

  // Subscription fields
  subscriptionTier      SubscriptionTier @default(community) @map("subscription_tier")
  subscriptionStartedAt DateTime?        @map("subscription_started_at")
  subscriptionExpiresAt DateTime?        @map("subscription_expires_at")
  stripeCustomerId      String?          @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?          @unique @map("stripe_subscription_id")

  // Janua multi-provider billing (Conekta for MX, Polar for international)
  januaCustomerId String? @unique @map("janua_customer_id")
  billingProvider String? @map("billing_provider") // 'conekta' | 'polar' | 'stripe' | 'stripe_mx' | 'paddle'
  countryCode     String? @map("country_code") // ISO country code for billing routing

  // Paddle billing (Merchant of Record for international)
  paddleCustomerId     String? @unique @map("paddle_customer_id")
  paddleSubscriptionId String? @unique @map("paddle_subscription_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  userSpaces          UserSpace[]
  sessions            Session[]
  auditLogs           AuditLog[]
  providerConnections ProviderConnection[]
  preferences         UserPreferences?
  billingEvents       BillingEvent[]
  usageMetrics        UsageMetric[]
  householdMembers    HouseholdMember[]
  simulations         Simulation[]
  ownedAccounts       Account[] // For "Yours/Mine/Ours" visibility
  transactionSplits   TransactionSplit[]
  sharedAccounts      AccountSharingPermission[] @relation("SharedAccounts")
  createdGoals        Goal[]                     @relation("GoalCreator")
  goalShares          GoalShare[]                @relation("GoalShares")
  sentGoalInvites     GoalShare[]                @relation("GoalInvites")
  goalActivities      GoalActivity[]             @relation("GoalActivities")
  notifications       UserNotification[]
  inactivityAlerts    InactivityAlert[]
  executorAssignments ExecutorAssignment[]       @relation("AccountHolder")
  assignedAsExecutor  ExecutorAssignment[]       @relation("Executor")

  @@index([onboardingCompleted, createdAt(sort: Desc)])
  @@index([lastLoginAt(sort: Desc)])
  @@index([lastActivityAt])
  @@index([lifeBeatEnabled])
  @@map("users")
}

model UserPreferences {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Notification preferences
  emailNotifications Boolean @default(true) @map("email_notifications")
  transactionAlerts  Boolean @default(true) @map("transaction_alerts")
  budgetAlerts       Boolean @default(true) @map("budget_alerts")
  weeklyReports      Boolean @default(true) @map("weekly_reports")
  monthlyReports     Boolean @default(true) @map("monthly_reports")
  securityAlerts     Boolean @default(true) @map("security_alerts")
  promotionalEmails  Boolean @default(false) @map("promotional_emails")

  // Mobile/Push notifications
  pushNotifications Boolean @default(true) @map("push_notifications")
  transactionPush   Boolean @default(true) @map("transaction_push")
  budgetPush        Boolean @default(true) @map("budget_push")
  securityPush      Boolean @default(true) @map("security_push")

  // Privacy preferences
  dataSharing       Boolean @default(false) @map("data_sharing")
  analyticsTracking Boolean @default(true) @map("analytics_tracking")
  personalizedAds   Boolean @default(false) @map("personalized_ads")

  // Display preferences
  dashboardLayout String  @default("standard") @map("dashboard_layout")
  chartType       String  @default("line") @map("chart_type")
  themeMode       String  @default("light") @map("theme_mode")
  compactView     Boolean @default(false) @map("compact_view")
  showBalances    Boolean @default(true) @map("show_balances")

  // Financial preferences
  defaultCurrency    Currency @default(MXN) @map("default_currency")
  hideSensitiveData  Boolean  @default(false) @map("hide_sensitive_data")
  autoCategorizeTxns Boolean  @default(true) @map("auto_categorize_txns")
  includeWeekends    Boolean  @default(true) @map("include_weekends")

  // ESG preferences
  esgScoreVisibility   Boolean @default(true) @map("esg_score_visibility")
  sustainabilityAlerts Boolean @default(false) @map("sustainability_alerts")
  impactReporting      Boolean @default(false) @map("impact_reporting")

  // Backup and export
  autoBackup      Boolean @default(false) @map("auto_backup")
  backupFrequency String? @map("backup_frequency")
  exportFormat    String  @default("csv") @map("export_format")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model UserNotification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // connection_error, connection_reauth, connection_degraded, budget_alert, etc.
  title     String
  message   String
  metadata  Json?    // Flexible payload for notification-specific data
  read      Boolean  @default(false)
  readAt    DateTime? @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type])
  @@map("user_notifications")
}

// Life Beat (Dead Man's Switch) - Inactivity Alerts
model InactivityAlert {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  alertLevel Int      @map("alert_level") // Days of inactivity: 30, 60, 90
  sentAt     DateTime @default(now()) @map("sent_at")
  channel    String   @default("email") // email, sms, push
  responded  Boolean  @default(false)
  respondedAt DateTime? @map("responded_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, alertLevel, sentAt])
  @@index([userId, alertLevel])
  @@index([sentAt(sort: Desc)])
  @@map("inactivity_alerts")
}

// Executor assignments for Life Beat
model ExecutorAssignment {
  id              String   @id @default(uuid())
  userId          String   @map("user_id") // Account holder
  executorEmail   String   @map("executor_email")
  executorName    String   @map("executor_name")
  executorUserId  String?  @map("executor_user_id") // If executor is also a user
  relationship    String   // spouse, child, sibling, attorney, financial_advisor, other
  priority        Int      @default(1) // Order of notification (1 = first)
  verified        Boolean  @default(false)
  verifiedAt      DateTime? @map("verified_at")
  accessGranted   Boolean  @default(false) @map("access_granted")
  accessGrantedAt DateTime? @map("access_granted_at")
  accessExpiresAt DateTime? @map("access_expires_at")
  accessToken     String?  @unique @map("access_token") // Secure one-time access token

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accountHolder User  @relation("AccountHolder", fields: [userId], references: [id], onDelete: Cascade)
  executor      User? @relation("Executor", fields: [executorUserId], references: [id], onDelete: SetNull)

  @@unique([userId, executorEmail])
  @@index([userId])
  @@index([executorUserId])
  @@index([accessToken])
  @@map("executor_assignments")
}

// Audit log for executor access actions
model ExecutorAccessLog {
  id                   String   @id @default(uuid())
  executorAssignmentId String   @map("executor_assignment_id")
  action               String   // viewed_accounts, viewed_transactions, downloaded_report, etc.
  resourceType         String?  @map("resource_type") // account, transaction, report
  resourceId           String?  @map("resource_id")
  ipAddress            String?  @map("ip_address")
  userAgent            String?  @map("user_agent")
  createdAt            DateTime @default(now()) @map("created_at")

  @@index([executorAssignmentId, createdAt(sort: Desc)])
  @@map("executor_access_logs")
}

model Session {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  tokenFamily      String   @unique @map("token_family")
  refreshTokenHash String   @map("refresh_token_hash")
  expiresAt        DateTime @map("expires_at")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenFamily])
  @@map("sessions")
}

model ProviderConnection {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  provider       Provider
  providerUserId String   @map("provider_user_id")
  encryptedToken String   @map("encrypted_token")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, providerUserId])
  @@index([userId])
  @@map("provider_connections")
}

model Space {
  id          String    @id @default(uuid())
  name        String
  type        SpaceType
  currency    Currency  @default(MXN)
  timezone    String    @default("America/Mexico_City")
  householdId String?   @map("household_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  household          Household?          @relation(fields: [householdId], references: [id], onDelete: SetNull)
  userSpaces         UserSpace[]
  accounts           Account[]
  budgets            Budget[]
  transactionRules   TransactionRule[]
  goals              Goal[]
  transactionOrders  TransactionOrder[]
  simulations        Simulation[]
  manualAssets       ManualAsset[]
  connectionAttempts ConnectionAttempt[]
  subscriptions      Subscription[]
  incomeEvents       IncomeEvent[]
  savedReports       SavedReport[]
  cashflowForecasts  CashflowForecast[]

  @@index([householdId])
  @@map("spaces")
}

model UserSpace {
  userId    String    @map("user_id")
  spaceId   String    @map("space_id")
  role      SpaceRole
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@id([userId, spaceId])
  @@map("user_spaces")
}

model Account {
  id                   String           @id @default(uuid())
  spaceId              String           @map("space_id")
  provider             Provider
  providerAccountId    String?          @map("provider_account_id")
  name                 String
  type                 AccountType
  subtype              String?
  currency             Currency
  balance              Decimal          @default(0) @db.Decimal(19, 4)
  ownership            AccountOwnership @default(individual)
  ownerId              String?          @map("owner_id") // UserID for individual accounts
  encryptedCredentials Json?            @map("encrypted_credentials")
  metadata             Json?
  lastSyncedAt         DateTime?        @map("last_synced_at")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  // Liability-specific fields (credit cards, loans, mortgages)
  liabilityType      String?   @map("liability_type") // credit, student, mortgage, auto, personal
  apr                Decimal?  @db.Decimal(6, 4) // Annual percentage rate (e.g., 0.1999 = 19.99%)
  minimumPayment     Decimal?  @map("minimum_payment") @db.Decimal(19, 4)
  nextPaymentDueDate DateTime? @map("next_payment_due_date") @db.Date
  lastPaymentAmount  Decimal?  @map("last_payment_amount") @db.Decimal(19, 4)
  lastPaymentDate    DateTime? @map("last_payment_date") @db.Date
  isOverdue          Boolean   @default(false) @map("is_overdue")
  creditLimit        Decimal?  @map("credit_limit") @db.Decimal(19, 4)
  originationDate    DateTime? @map("origination_date") @db.Date
  originalPrincipal  Decimal?  @map("original_principal") @db.Decimal(19, 4)

  // Relations
  space                Space                      @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  owner                User?                      @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  transactions         Transaction[]
  assetValuations      AssetValuation[]
  esgScores            ESGScore[]
  connection           Connection?
  goalAllocations      GoalAllocation[]
  transactionOrders    TransactionOrder[]
  transferDestinations TransactionOrder[]         @relation("TransferDestination")
  connectionAttempts   ConnectionAttempt[]
  sharingPermissions   AccountSharingPermission[]

  @@unique([spaceId, provider, providerAccountId])
  @@index([spaceId])
  @@index([spaceId, ownership])
  @@index([spaceId, ownerId])
  @@index([spaceId, lastSyncedAt(sort: Desc)])
  @@map("accounts")
}

model Connection {
  id        String           @id @default(uuid())
  accountId String           @unique @map("account_id")
  status    ConnectionStatus
  error     String?
  metadata  Json?
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("connections")
}

model Transaction {
  id                    String   @id @default(uuid())
  accountId             String   @map("account_id")
  providerTransactionId String?  @map("provider_transaction_id")
  amount                Decimal  @db.Decimal(19, 4)
  currency              Currency
  description           String
  merchant              String?
  categoryId            String?  @map("category_id")
  recurringId           String?  @map("recurring_id")
  date                  DateTime @db.Date
  pending               Boolean  @default(false)
  isSplit               Boolean  @default(false) @map("is_split") // Transaction split between users
  metadata              Json?
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  account   Account               @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category  Category?             @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  recurring RecurringTransaction? @relation(fields: [recurringId], references: [id], onDelete: SetNull)
  splits    TransactionSplit[]

  @@unique([accountId, providerTransactionId])
  @@index([accountId, date(sort: Desc)])
  @@index([categoryId])
  @@index([accountId, categoryId])
  @@index([pending])
  @@index([isSplit])
  @@index([recurringId])
  @@map("transactions")
}

// Recurring Transaction Detection & Tracking
model RecurringTransaction {
  id              String              @id @default(uuid())
  spaceId         String              @map("space_id")
  merchantName    String              @map("merchant_name")
  merchantPattern String?             @map("merchant_pattern") // Regex pattern for matching
  expectedAmount  Decimal             @map("expected_amount") @db.Decimal(19, 4)
  amountVariance  Decimal             @default(0.1) @map("amount_variance") @db.Decimal(5, 2) // 10% variance allowed
  currency        Currency
  frequency       RecurrenceFrequency
  status          RecurringStatus     @default(detected)
  categoryId      String?             @map("category_id")

  // Tracking fields
  lastOccurrence  DateTime? @map("last_occurrence") @db.Date
  nextExpected    DateTime? @map("next_expected") @db.Date
  occurrenceCount Int       @default(0) @map("occurrence_count")
  confidence      Decimal   @default(0) @map("confidence") @db.Decimal(3, 2) // 0.00 to 1.00

  // Detection metadata
  firstDetectedAt DateTime  @default(now()) @map("first_detected_at")
  confirmedAt     DateTime? @map("confirmed_at")
  dismissedAt     DateTime? @map("dismissed_at")

  // Notification preferences
  alertBeforeDays Int     @default(3) @map("alert_before_days")
  alertEnabled    Boolean @default(true) @map("alert_enabled")

  notes     String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  transactions Transaction[]
  subscription Subscription?

  @@unique([spaceId, merchantName, frequency])
  @@index([spaceId, status])
  @@index([spaceId, nextExpected])
  @@index([status, nextExpected])
  @@map("recurring_transactions")
}

model Subscription {
  id          String  @id @default(uuid())
  spaceId     String  @map("space_id")
  recurringId String? @unique @map("recurring_id") // Link to detected recurring pattern

  // Service details
  serviceName String               @map("service_name")
  serviceUrl  String?              @map("service_url")
  serviceIcon String?              @map("service_icon")
  category    SubscriptionCategory @default(other)
  description String?

  // Billing details
  amount          Decimal             @db.Decimal(19, 4)
  currency        Currency
  billingCycle    RecurrenceFrequency @map("billing_cycle")
  nextBillingDate DateTime?           @map("next_billing_date") @db.Date
  lastBillingDate DateTime?           @map("last_billing_date") @db.Date

  // Status tracking
  status             SubscriptionStatus @default(active)
  startDate          DateTime           @map("start_date") @db.Date
  endDate            DateTime?          @map("end_date") @db.Date
  trialEndDate       DateTime?          @map("trial_end_date") @db.Date
  cancelledAt        DateTime?          @map("cancelled_at")
  cancellationReason String?            @map("cancellation_reason")

  // Savings & recommendations
  annualCost            Decimal @map("annual_cost") @db.Decimal(19, 4)
  usageFrequency        String? @map("usage_frequency") // low, medium, high, unknown
  savingsRecommendation String? @map("savings_recommendation")
  alternativeServices   Json?   @map("alternative_services") // [{name, price, url}]

  // Notification preferences
  alertBeforeDays Int     @default(3) @map("alert_before_days")
  alertEnabled    Boolean @default(true) @map("alert_enabled")

  notes     String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  space            Space                 @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  recurringPattern RecurringTransaction? @relation(fields: [recurringId], references: [id], onDelete: SetNull)

  @@unique([spaceId, serviceName])
  @@index([spaceId, status])
  @@index([spaceId, nextBillingDate])
  @@index([status, nextBillingDate])
  @@map("subscriptions")
}

model Category {
  id              String   @id @default(uuid())
  budgetId        String   @map("budget_id")
  name            String
  budgetedAmount  Decimal  @map("budgeted_amount") @db.Decimal(19, 4)
  carryoverAmount Decimal  @default(0) @map("carryover_amount") @db.Decimal(19, 4)
  icon            String?
  color           String?
  description     String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  budget       Budget              @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  rules        TransactionRule[]
  allocations  IncomeAllocation[]
  goal         CategoryGoal?

  @@unique([budgetId, name])
  @@index([budgetId])
  @@map("categories")
}

// Zero-Based Budgeting - Category Goal Types
enum CategoryGoalType {
  monthly_spending // Target spending amount per month
  target_balance // Save X amount by date Y
  weekly_spending // Target spending amount per week
  percentage_income // Allocate X% of income to this category
}

// Zero-Based Budgeting - Income Event (when money comes in)
model IncomeEvent {
  id          String   @id @default(uuid())
  spaceId     String   @map("space_id")
  amount      Decimal  @db.Decimal(19, 4)
  currency    Currency
  source      String // "paycheck", "freelance", "refund", "bonus", "transfer", "other"
  description String?
  receivedAt  DateTime @map("received_at")
  isAllocated Boolean  @default(false) @map("is_allocated")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  space       Space              @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  allocations IncomeAllocation[]

  @@index([spaceId, receivedAt(sort: Desc)])
  @@index([spaceId, isAllocated])
  @@map("income_events")
}

// Zero-Based Budgeting - Income Allocation (how income is assigned to categories)
model IncomeAllocation {
  id            String   @id @default(uuid())
  incomeEventId String   @map("income_event_id")
  categoryId    String   @map("category_id")
  amount        Decimal  @db.Decimal(19, 4)
  notes         String?
  allocatedAt   DateTime @default(now()) @map("allocated_at")

  // Relations
  incomeEvent IncomeEvent @relation(fields: [incomeEventId], references: [id], onDelete: Cascade)
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([incomeEventId])
  @@index([categoryId])
  @@map("income_allocations")
}

// Zero-Based Budgeting - Category Goal (funding targets)
model CategoryGoal {
  id               String           @id @default(uuid())
  categoryId       String           @unique @map("category_id")
  goalType         CategoryGoalType @map("goal_type")
  targetAmount     Decimal?         @map("target_amount") @db.Decimal(19, 4)
  targetDate       DateTime?        @map("target_date") @db.Date
  monthlyFunding   Decimal?         @map("monthly_funding") @db.Decimal(19, 4)
  percentageTarget Decimal?         @map("percentage_target") @db.Decimal(5, 2) // For percentage_income type
  notes            String?
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("category_goals")
}

model TransactionRule {
  id         String   @id @default(uuid())
  spaceId    String   @map("space_id")
  name       String
  conditions Json
  categoryId String?  @map("category_id")
  priority   Int      @default(0)
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  space    Space     @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([spaceId, enabled])
  @@map("transaction_rules")
}

model Budget {
  id              String       @id @default(uuid())
  spaceId         String       @map("space_id")
  name            String
  period          BudgetPeriod
  startDate       DateTime     @map("start_date") @db.Date
  endDate         DateTime?    @map("end_date") @db.Date
  income          Decimal      @default(0) @db.Decimal(19, 4)
  rolloverEnabled Boolean      @default(false) @map("rollover_enabled")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  space      Space      @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  categories Category[]

  @@index([spaceId])
  @@map("budgets")
}

model AssetValuation {
  id        String   @id @default(uuid())
  accountId String   @map("account_id")
  date      DateTime @db.Date
  value     Decimal  @db.Decimal(19, 4)
  currency  Currency
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, date])
  @@index([accountId, date(sort: Desc)])
  @@map("asset_valuations")
}

model ESGScore {
  id                 String   @id @default(uuid())
  accountId          String   @map("account_id")
  assetSymbol        String   @map("asset_symbol")
  environmentalScore Decimal? @map("environmental_score") @db.Decimal(5, 2)
  socialScore        Decimal? @map("social_score") @db.Decimal(5, 2)
  governanceScore    Decimal? @map("governance_score") @db.Decimal(5, 2)
  compositeScore     Decimal? @map("composite_score") @db.Decimal(5, 2)
  calculatedAt       DateTime @map("calculated_at")
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, calculatedAt(sort: Desc)])
  @@map("esg_scores")
}

model ManualAsset {
  id              String          @id @default(uuid())
  spaceId         String          @map("space_id")
  name            String
  type            ManualAssetType
  description     String?
  currentValue    Decimal         @map("current_value") @db.Decimal(19, 4)
  currency        Currency
  acquisitionDate DateTime?       @map("acquisition_date") @db.Date
  acquisitionCost Decimal?        @map("acquisition_cost") @db.Decimal(19, 4)

  // Asset-specific metadata stored as JSON
  // Real Estate: { address, city, state, zip, sqft, propertyType, bedrooms, bathrooms }
  // Vehicle: { vin, make, model, year, mileage, licensePlate }
  // Domain: { domain, registrar, expiryDate, registrationDate }
  // Private Equity: { companyName, investmentDate, ownershipPercentage, shares, shareClass }
  // Collectible: { category, manufacturer, year, condition, authenticity }
  metadata Json?

  // Document tracking (stored in S3/external storage)
  // Array of { key, url, filename, uploadedAt, fileType, category }
  documents Json?

  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  space            Space                    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  valuationHistory ManualAssetValuation[]
  cashFlows        PrivateEquityCashFlow[]

  @@index([spaceId])
  @@index([type])
  @@map("manual_assets")
}

model ManualAssetValuation {
  id        String   @id @default(uuid())
  assetId   String   @map("asset_id")
  date      DateTime @db.Date
  value     Decimal  @db.Decimal(19, 4)
  currency  Currency
  source    String? // e.g., "Zillow API", "Manual Entry", "Professional Appraisal"
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  asset ManualAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, date])
  @@index([assetId, date(sort: Desc)])
  @@map("manual_asset_valuations")
}

// Private Equity Cash Flow Tracking
model PrivateEquityCashFlow {
  id          String         @id @default(uuid())
  assetId     String         @map("asset_id")
  type        PECashFlowType
  amount      Decimal        @db.Decimal(19, 4)
  currency    Currency
  date        DateTime       @db.Date
  description String?
  notes       String?
  metadata    Json? // Additional info like call number, distribution type, etc.
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Relations
  asset ManualAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, date(sort: Desc)])
  @@index([assetId, type])
  @@map("private_equity_cash_flows")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  resource   String?
  resourceId String?  @map("resource_id")
  metadata   String? // JSON string
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  severity   String   @default("low") // low, medium, high, critical
  timestamp  DateTime @default(now())
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, action, timestamp(sort: Desc)])
  @@index([resource, resourceId])
  @@index([severity, timestamp(sort: Desc)])
  @@map("audit_logs")
}

model WebhookEvent {
  id          String    @id @default(uuid())
  provider    Provider
  eventType   String    @map("event_type")
  payload     Json
  signature   String
  processed   Boolean   @default(false)
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")

  @@index([provider, processed, createdAt])
  @@map("webhook_events")
}

model ErrorLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  level     String
  message   String
  stack     String?
  context   Json?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([timestamp])
  @@index([level])
  @@index([message])
  @@map("error_logs")
}

model ExchangeRate {
  id           String   @id @default(uuid())
  fromCurrency Currency @map("from_currency")
  toCurrency   Currency @map("to_currency")
  rate         Float
  date         DateTime @db.Date
  source       String   @default("banxico")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([fromCurrency, toCurrency, date])
  @@index([fromCurrency, toCurrency])
  @@index([date])
  @@map("exchange_rates")
}

model BillingEvent {
  id            String           @id @default(uuid())
  userId        String           @map("user_id")
  type          BillingEventType
  amount        Decimal          @db.Decimal(10, 2)
  currency      Currency         @default(USD)
  status        BillingStatus
  stripeEventId String?          @unique @map("stripe_event_id")
  metadata      Json?
  createdAt     DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@map("billing_events")
}

model UsageMetric {
  id         String          @id @default(uuid())
  userId     String          @map("user_id")
  metricType UsageMetricType @map("metric_type")
  count      Int             @default(1)
  date       DateTime        @db.Date
  metadata   Json?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, metricType, date])
  @@index([userId, date(sort: Desc)])
  @@index([metricType, date])
  @@map("usage_metrics")
}

model Goal {
  id           String     @id @default(uuid())
  spaceId      String     @map("space_id")
  householdId  String?    @map("household_id")
  name         String
  description  String?
  type         GoalType
  targetAmount Decimal    @db.Decimal(19, 4)
  currency     Currency   @default(USD)
  targetDate   DateTime   @db.Date
  priority     Int        @default(1)
  status       GoalStatus @default(active)
  notes        String?
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Probabilistic Planning Fields (Monte Carlo Integration)
  currentProbability  Decimal?  @map("current_probability") @db.Decimal(5, 2) // 0-100 (e.g., 73.45%)
  confidenceLow       Decimal?  @map("confidence_low") @db.Decimal(19, 4) // P10 projected value
  confidenceHigh      Decimal?  @map("confidence_high") @db.Decimal(19, 4) // P90 projected value
  lastSimulationAt    DateTime? @map("last_simulation_at")
  probabilityHistory  Json?     @map("probability_history") // [{date, probability}, ...]
  currentProgress     Decimal?  @map("current_progress") @db.Decimal(5, 2) // 0-100 (% of target reached)
  projectedCompletion DateTime? @map("projected_completion") @db.Date // Median completion date

  // Monte Carlo Configuration (inherited from user's risk profile)
  expectedReturn      Decimal? @map("expected_return") @db.Decimal(5, 4) // Annual return (e.g., 0.07 = 7%)
  volatility          Decimal? @map("volatility") @db.Decimal(5, 4) // Annual volatility (e.g., 0.15 = 15%)
  monthlyContribution Decimal? @map("monthly_contribution") @db.Decimal(19, 4) // Regular contribution amount

  // Collaboration Fields
  createdBy         String? @map("created_by") // User who created the goal
  isShared          Boolean @default(false) @map("is_shared")
  sharedWithMessage String? @map("shared_with_message") // Optional message when sharing

  // Relations
  space             Space              @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  household         Household?         @relation(fields: [householdId], references: [id], onDelete: SetNull)
  creator           User?              @relation("GoalCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  allocations       GoalAllocation[]
  transactionOrders TransactionOrder[]
  simulations       Simulation[]
  shares            GoalShare[]
  activities        GoalActivity[]

  @@index([spaceId, status])
  @@index([spaceId, createdAt(sort: Desc)])
  @@index([householdId])
  @@index([currentProbability])
  @@index([createdBy])
  @@index([isShared])
  @@index([status, updatedAt(sort: Desc)])
  @@map("goals")
}

model GoalAllocation {
  id         String   @id @default(uuid())
  goalId     String   @map("goal_id")
  accountId  String   @map("account_id")
  percentage Decimal  @db.Decimal(5, 2)
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  goal    Goal    @relation(fields: [goalId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([goalId, accountId])
  @@index([goalId])
  @@index([accountId])
  @@map("goal_allocations")
}

model GoalShare {
  id         String          @id @default(uuid())
  goalId     String          @map("goal_id")
  sharedWith String          @map("shared_with") // User ID
  role       GoalShareRole   @default(viewer)
  invitedBy  String          @map("invited_by") // User ID
  status     GoalShareStatus @default(pending)
  message    String? // Optional message when sharing
  acceptedAt DateTime?       @map("accepted_at")
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")

  // Relations
  goal    Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user    User @relation("GoalShares", fields: [sharedWith], references: [id], onDelete: Cascade)
  inviter User @relation("GoalInvites", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@unique([goalId, sharedWith])
  @@index([goalId])
  @@index([sharedWith])
  @@index([status])
  @@map("goal_shares")
}

model GoalActivity {
  id        String             @id @default(uuid())
  goalId    String             @map("goal_id")
  userId    String             @map("user_id")
  action    GoalActivityAction
  metadata  Json? // Additional context about the action
  createdAt DateTime           @default(now()) @map("created_at")

  // Relations
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user User @relation("GoalActivities", fields: [userId], references: [id], onDelete: Cascade)

  @@index([goalId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("goal_activities")
}

model Simulation {
  id              String         @id @default(uuid())
  userId          String         @map("user_id")
  spaceId         String?        @map("space_id")
  goalId          String?        @map("goal_id")
  type            SimulationType
  config          Json
  result          Json?
  status          String         @default("pending") // pending, running, completed, failed
  errorMessage    String?        @map("error_message")
  executionTimeMs Int?           @map("execution_time_ms")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  space Space? @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  goal  Goal?  @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([spaceId])
  @@index([goalId])
  @@index([type])
  @@map("simulations")
}

model Household {
  id           String        @id @default(uuid())
  name         String
  type         HouseholdType @default(family)
  baseCurrency Currency      @default(USD)
  description  String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  members HouseholdMember[]
  spaces  Space[]
  goals   Goal[]
  wills   Will[]

  @@index([createdAt])
  @@map("households")
}

model HouseholdMember {
  id              String           @id @default(uuid())
  householdId     String           @map("household_id")
  userId          String           @map("user_id")
  relationship    RelationshipType
  isMinor         Boolean          @default(false) @map("is_minor")
  accessStartDate DateTime?        @map("access_start_date") @db.Date
  notes           String?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relations
  household               Household                @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  beneficiaryDesignations BeneficiaryDesignation[]
  willExecutorRoles       WillExecutor[]

  @@unique([householdId, userId])
  @@index([householdId])
  @@index([userId])
  @@map("household_members")
}

model Will {
  id              String     @id @default(uuid())
  householdId     String     @map("household_id")
  name            String // e.g., "Smith Family Will 2025"
  status          WillStatus @default(draft)
  lastReviewedAt  DateTime?  @map("last_reviewed_at")
  activatedAt     DateTime?  @map("activated_at")
  revokedAt       DateTime?  @map("revoked_at")
  executedAt      DateTime?  @map("executed_at")
  notes           String?    @db.Text
  legalDisclaimer Boolean    @default(false) @map("legal_disclaimer") // User accepted disclaimer
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  household     Household                @relation(fields: [householdId], references: [id], onDelete: Cascade)
  beneficiaries BeneficiaryDesignation[]
  executors     WillExecutor[]

  @@index([householdId])
  @@index([status])
  @@map("wills")
}

model BeneficiaryDesignation {
  id            String    @id @default(uuid())
  willId        String    @map("will_id")
  beneficiaryId String    @map("beneficiary_id") // HouseholdMember ID
  assetType     AssetType
  assetId       String?   @map("asset_id") // Optional: specific account ID
  percentage    Decimal   @db.Decimal(5, 2) // 0.00 to 100.00
  conditions    Json? // Optional conditions (age, event, etc.)
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  will        Will            @relation(fields: [willId], references: [id], onDelete: Cascade)
  beneficiary HouseholdMember @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)

  @@index([willId])
  @@index([beneficiaryId])
  @@map("beneficiary_designations")
}

model WillExecutor {
  id         String    @id @default(uuid())
  willId     String    @map("will_id")
  executorId String    @map("executor_id") // HouseholdMember ID
  isPrimary  Boolean   @default(false) @map("is_primary")
  order      Int       @default(1) // Execution order if primary fails
  acceptedAt DateTime? @map("accepted_at")
  notes      String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  will     Will            @relation(fields: [willId], references: [id], onDelete: Cascade)
  executor HouseholdMember @relation(fields: [executorId], references: [id], onDelete: Cascade)

  @@index([willId])
  @@index([executorId])
  @@map("will_executors")
}

// Transaction Execution Enums
enum OrderType {
  buy
  sell
  transfer
  deposit
  withdraw
}

enum OrderStatus {
  pending_verification // Awaiting OTP/2FA
  pending_execution // Verified, queued for execution
  pending_trigger // Waiting for price trigger (advanced orders)
  executing // Currently being executed
  completed // Successfully executed
  failed // Execution failed
  cancelled // User cancelled
  rejected // Rejected by system (limits, validation, etc.)
  expired // Order expired
}

enum AdvancedOrderType {
  stop_loss // Sell when price drops below threshold
  take_profit // Sell when price reaches target
  trailing_stop // Dynamic stop-loss that follows price
  oco // One cancels other
}

enum RecurrencePattern {
  once
  daily
  weekly
  monthly
  quarterly
}

enum RecurrenceFrequency {
  daily
  weekly
  biweekly
  monthly
  quarterly
  yearly
}

enum RecurringStatus {
  detected // Auto-detected, awaiting user confirmation
  confirmed // User confirmed as recurring
  dismissed // User dismissed detection
  paused // User paused tracking
}

enum SubscriptionStatus {
  active
  trial
  paused
  cancelled
  expired
}

enum SubscriptionCategory {
  streaming
  software
  news
  gaming
  music
  fitness
  food_delivery
  cloud_storage
  productivity
  education
  finance
  other
}

enum OrderPriority {
  low
  normal
  high
  critical // Goal-driven auto-execution
}

enum ExecutionProvider {
  bitso
  plaid
  belvo
  manual
}

// Transaction Execution Models
model TransactionOrder {
  id             String @id @default(uuid())
  spaceId        String @map("space_id")
  userId         String @map("user_id")
  accountId      String @map("account_id")
  idempotencyKey String @unique @map("idempotency_key")

  // Order details
  type     OrderType
  status   OrderStatus   @default(pending_verification)
  priority OrderPriority @default(normal)

  // Financial details
  amount      Decimal  @db.Decimal(19, 4)
  currency    Currency
  assetSymbol String?  @map("asset_symbol") // For crypto/stocks
  targetPrice Decimal? @map("target_price") @db.Decimal(19, 4) // Limit orders

  // Transfer details (for transfer orders)
  toAccountId String? @map("to_account_id")

  // Execution settings
  provider    ExecutionProvider
  dryRun      Boolean           @default(false) @map("dry_run")
  maxSlippage Decimal?          @map("max_slippage") @db.Decimal(5, 2) // Percentage

  // Advanced order types (Phase 3)
  advancedType    AdvancedOrderType? @map("advanced_type")
  stopPrice       Decimal?           @map("stop_price") @db.Decimal(19, 4)
  takeProfitPrice Decimal?           @map("take_profit_price") @db.Decimal(19, 4)
  trailingAmount  Decimal?           @map("trailing_amount") @db.Decimal(19, 4) // Fixed amount
  trailingPercent Decimal?           @map("trailing_percent") @db.Decimal(5, 2) // Percentage
  linkedOrderId   String?            @map("linked_order_id") // For OCO orders
  highestPrice    Decimal?           @map("highest_price") @db.Decimal(19, 4) // For trailing stop tracking
  lastPriceCheck  DateTime?          @map("last_price_check") // Last time price was checked

  // Scheduling & recurrence (Phase 3)
  scheduledFor    DateTime?          @map("scheduled_for")
  recurrence      RecurrencePattern? @default(once)
  recurrenceDay   Int?               @map("recurrence_day") // Day of week (1-7) or month (1-31)
  recurrenceEnd   DateTime?          @map("recurrence_end")
  nextExecutionAt DateTime?          @map("next_execution_at")
  executionCount  Int                @default(0) @map("execution_count")
  maxExecutions   Int?               @map("max_executions")

  // Verification & Security
  otpVerified   Boolean   @default(false) @map("otp_verified")
  otpVerifiedAt DateTime? @map("otp_verified_at")
  ipAddress     String?   @map("ip_address")
  userAgent     String?   @map("user_agent")

  // Goal-driven execution
  goalId      String? @map("goal_id")
  autoExecute Boolean @default(false) @map("auto_execute")

  // Execution results
  executedAmount Decimal?  @map("executed_amount") @db.Decimal(19, 4)
  executedPrice  Decimal?  @map("executed_price") @db.Decimal(19, 4)
  fees           Decimal?  @db.Decimal(19, 4)
  feeCurrency    Currency? @map("fee_currency")

  // Provider response
  providerOrderId  String? @map("provider_order_id")
  providerResponse Json?   @map("provider_response")

  // Metadata
  notes    String? @db.Text
  metadata Json?

  // Error tracking
  errorCode    String? @map("error_code")
  errorMessage String? @map("error_message") @db.Text

  // Timestamps
  submittedAt DateTime  @default(now()) @map("submitted_at")
  verifiedAt  DateTime? @map("verified_at")
  executedAt  DateTime? @map("executed_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")
  expiresAt   DateTime? @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  space      Space            @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  account    Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  toAccount  Account?         @relation("TransferDestination", fields: [toAccountId], references: [id], onDelete: SetNull)
  goal       Goal?            @relation(fields: [goalId], references: [id], onDelete: SetNull)
  executions OrderExecution[]

  @@index([spaceId, status, createdAt(sort: Desc)])
  @@index([userId, status])
  @@index([accountId])
  @@index([status, priority])
  @@index([goalId])
  @@index([idempotencyKey])
  @@index([status, advancedType, lastPriceCheck]) // For price monitoring
  @@index([status, scheduledFor]) // For scheduled execution
  @@index([status, nextExecutionAt]) // For recurring orders
  @@map("transaction_orders")
}

model OrderExecution {
  id      String @id @default(uuid())
  orderId String @map("order_id")

  // Execution attempt details
  attemptNumber Int         @default(1) @map("attempt_number")
  status        OrderStatus

  // Execution details
  provider        ExecutionProvider
  providerOrderId String?           @map("provider_order_id")

  // Results
  executedAmount Decimal?  @map("executed_amount") @db.Decimal(19, 4)
  executedPrice  Decimal?  @map("executed_price") @db.Decimal(19, 4)
  fees           Decimal?  @db.Decimal(19, 4)
  feeCurrency    Currency? @map("fee_currency")

  // Error tracking
  errorCode    String? @map("error_code")
  errorMessage String? @map("error_message") @db.Text

  // Raw provider response
  providerRequest  Json? @map("provider_request")
  providerResponse Json? @map("provider_response")

  // Audit trail
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  duration    Int? // Milliseconds

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  order TransactionOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, attemptNumber])
  @@index([status, startedAt(sort: Desc)])
  @@map("order_executions")
}

model IdempotencyKey {
  id      String @id @default(uuid())
  key     String @unique
  userId  String @map("user_id")
  spaceId String @map("space_id")

  // Request details
  requestHash String  @map("request_hash") // Hash of request body
  orderId     String? @map("order_id") // Created order ID

  // Response caching
  responseStatus Int?  @map("response_status")
  responseBody   Json? @map("response_body")

  // Expiration
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, spaceId, createdAt(sort: Desc)])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

model OrderLimit {
  id      String  @id @default(uuid())
  userId  String  @map("user_id")
  spaceId String? @map("space_id") // Null = global user limit

  // Limit configuration
  limitType String     @map("limit_type") // daily, weekly, monthly, per_transaction
  orderType OrderType? @map("order_type") // Null = all order types

  // Amounts
  maxAmount Decimal  @map("max_amount") @db.Decimal(19, 4)
  currency  Currency

  // Usage tracking
  usedAmount Decimal  @default(0) @map("used_amount") @db.Decimal(19, 4)
  resetAt    DateTime @map("reset_at")

  // Metadata
  notes    String?
  enforced Boolean @default(true) // Can be disabled for testing

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, spaceId, limitType, orderType])
  @@index([userId, enforced, resetAt])
  @@index([spaceId])
  @@map("order_limits")
}

// Multi-Provider Redundancy Models

model InstitutionProviderMapping {
  id               String    @id @default(uuid())
  institutionId    String    @map("institution_id") // External institution ID (e.g., "ins_123" from Plaid)
  institutionName  String    @map("institution_name")
  primaryProvider  Provider  @map("primary_provider")
  backupProviders  Json // Array of backup Provider enums
  region           String    @default("US") // US, MX, EU
  providerMetadata Json?     @map("provider_metadata") // Provider-specific config
  lastHealthCheck  DateTime? @map("last_health_check")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@unique([institutionId, primaryProvider])
  @@index([institutionName])
  @@index([region])
  @@map("institution_provider_mappings")
}

model ProviderHealthStatus {
  id                 String    @id @default(uuid())
  provider           Provider
  region             String    @default("US")
  status             String    @default("healthy") // healthy, degraded, down
  errorRate          Decimal   @default(0) @map("error_rate") @db.Decimal(5, 2) // Percentage
  avgResponseTimeMs  Int       @default(0) @map("avg_response_time_ms")
  successfulCalls    Int       @default(0) @map("successful_calls")
  failedCalls        Int       @default(0) @map("failed_calls")
  lastSuccessAt      DateTime? @map("last_success_at")
  lastFailureAt      DateTime? @map("last_failure_at")
  lastError          String?   @map("last_error")
  circuitBreakerOpen Boolean   @default(false) @map("circuit_breaker_open")
  windowStartAt      DateTime  @default(now()) @map("window_start_at") // Rolling window start
  lastHealthCheckAt  DateTime? @map("last_health_check_at")
  rateLimited        Boolean   @default(false) @map("rate_limited")
  rateLimitResetAt   DateTime? @map("rate_limit_reset_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@unique([provider, region])
  @@index([status])
  @@index([circuitBreakerOpen])
  @@index([rateLimited])
  @@map("provider_health_status")
}

model ConnectionAttempt {
  id               String    @id @default(uuid())
  accountId        String?   @map("account_id")
  spaceId          String    @map("space_id")
  provider         Provider
  institutionId    String?   @map("institution_id")
  attemptType      String    @map("attempt_type") // initial, sync, reconnect
  status           String // success, failure, timeout
  errorCode        String?   @map("error_code")
  errorMessage     String?   @map("error_message")
  responseTimeMs   Int?      @map("response_time_ms")
  failoverUsed     Boolean   @default(false) @map("failover_used")
  failoverProvider Provider? @map("failover_provider")
  metadata         Json?
  attemptedAt      DateTime  @default(now()) @map("attempted_at")

  // Relations
  account Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  space   Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([accountId, attemptedAt(sort: Desc)])
  @@index([provider, status, attemptedAt(sort: Desc)])
  @@index([spaceId, attemptedAt(sort: Desc)])
  @@map("connection_attempts")
}

// Transaction Splits (for Yours/Mine/Ours at transaction level)
model TransactionSplit {
  id            String   @id @default(uuid())
  transactionId String   @map("transaction_id")
  userId        String   @map("user_id")
  amount        Decimal  @db.Decimal(19, 4) // Amount allocated to this user
  percentage    Decimal? @db.Decimal(5, 2) // Percentage of total (optional)
  note          String? // Optional note for this split
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([transactionId, userId])
  @@index([userId])
  @@index([transactionId])
  @@map("transaction_splits")
}

// Category Correction (ML Learning Loop)
model CategoryCorrection {
  id                String   @id @default(uuid())
  spaceId           String   @map("space_id")
  transactionId     String   @map("transaction_id")
  originalCategoryId String? @map("original_category_id")
  correctedCategoryId String @map("corrected_category_id")
  merchantPattern   String?  @map("merchant_pattern") // Normalized merchant name for pattern learning
  descriptionPattern String? @map("description_pattern") // Key terms from description
  confidence        Decimal? @db.Decimal(3, 2) // Original prediction confidence (0.00 to 1.00)
  createdBy         String   @map("created_by") // User who made the correction
  appliedToFuture   Boolean  @default(true) @map("applied_to_future") // Whether to apply to future similar transactions
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([spaceId, merchantPattern])
  @@index([spaceId, createdAt(sort: Desc)])
  @@index([correctedCategoryId])
  @@map("category_corrections")
}

// Account Sharing Permissions (for Yours/Mine/Ours flexibility)
model AccountSharingPermission {
  id           String    @id @default(uuid())
  accountId    String    @map("account_id")
  sharedWithId String    @map("shared_with_id") // User ID who gets access
  canView      Boolean   @default(true) @map("can_view")
  canEdit      Boolean   @default(false) @map("can_edit")
  canDelete    Boolean   @default(false) @map("can_delete")
  expiresAt    DateTime? @map("expires_at") // Optional expiration
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  account    Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sharedWith User    @relation("SharedAccounts", fields: [sharedWithId], references: [id], onDelete: Cascade)

  @@unique([accountId, sharedWithId])
  @@index([sharedWithId])
  @@index([accountId, canView])
  @@map("account_sharing_permissions")
}

model SavedReport {
  id        String    @id @default(cuid())
  spaceId   String    @map("space_id")
  name      String
  type      String    // monthly_spending, quarterly_net_worth, annual_tax, custom
  schedule  String?   // cron expression or null for on-demand
  format    String    @default("pdf") // pdf, csv
  filters   Json?     // date range, categories, accounts
  lastRunAt DateTime? @map("last_run_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([spaceId])
  @@map("saved_reports")
}

model CashflowForecast {
  id          String   @id @default(cuid())
  spaceId     String   @map("space_id")
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  weeks       Json     // Array of { weekStart, income, expenses, net, balance }
  confidence  Float    @default(0.85)
  generatedAt DateTime @default(now()) @map("generated_at")

  // Relations
  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([spaceId])
  @@map("cashflow_forecasts")
}
